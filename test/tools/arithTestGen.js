const two256 = 115792089237316195423570985008687907853269984665640564039457584007913129639935n; // 2^256-1
const P2_384 = (2n ** 384n) - 1n;
const P_BN254 = 21888242871839275222246405745257275088696311157297823662689037894645226208583n;
const P_BLS12381 = 0x1a0111ea397fe69a4b1ba7b6434bacd764774b84f38512bf6730d2a0f6b0f6241eabfffeb153ffffb9feffffffffaaabn;

const eqs = { ARITH: { eq: 1, file: 'standard',  rcheck: ['$${var _arithComp = A*B + C}', 
                                                          '${_arithComp >> 256} => D', 
                                                          '${_arithComp} => E  :ARITH']},

              ARITH_BN254_ADDFP2: { eq: 5, rcheck: ['${(A+C) % const.BN254_P} => E', 
                                                    '${(B+D) % const.BN254_P} :ARITH_BN254_ADDFP2', 
                                                    '${ARITH_BN254_ADDFP2(A,C)} => E',
                                                    '${ARITH_BN254_ADDFP2(B,D)} :ARITH_BN254_ADDFP2']},

              ARITH_BN254_SUBFP2: { eq: 6, rcheck: ['${(A + const.BN254_P - C) % const.BN254_P} => E', 
                                                    '${(B + const.BN254_P - D) % const.BN254_P} :ARITH_BN254_SUBFP2',
                                                    '${ARITH_BN254_SUBFP2(A,C)} => E',
                                                    '${ARITH_BN254_SUBFP2(B,D)} :ARITH_BN254_SUBFP2']},

              ARITH_BN254_MULFP2: { eq: 4, rcheck: ['${(A*C) >= (B*D) ? (((A*C)-(B*D)) % const.BN254_P) : (const.BN254_P - (((B*D)-(A*C)) % const.BN254_P))} => E', 
                                                    '${((A*D)+(B*C)) % const.BN254_P} :ARITH_BN254_MULFP2', 
                                                    '${ARITH_BN254_MULFP2_X(A,B,C,D)} => E',
                                                    '${ARITH_BN254_MULFP2_Y(A,B,C,D)} :ARITH_BN254_MULFP2']},

              ARITH_MOD: { eq: 7, file: 'modular', rcheck: ['${(A*B + C) % D} :ARITH_MOD', 
                                                            '$ :ARITH_MOD']},

              ARITH_384_MOD: { eq: 8, file: 'modular_384', rcheck: ['${(A*B + C) % D} :ARITH_384_MOD', 
                                                                    '$ :ARITH_384_MOD']},

              ARITH_BLS12381_ADDFP2: { eq: 10, rcheck: ['${(A+C) % const.BLS12381_P} => E', 
                                                       '${(B+D) % const.BLS12381_P} :ARITH_BLS12381_ADDFP2', 
                                                       '${ARITH_BLS12381_ADDFP2(A,C)} => E',
                                                       '${ARITH_BLS12381_ADDFP2(B,D)} :ARITH_BLS12381_ADDFP2']},

              ARITH_BLS12381_SUBFP2: { eq: 11, rcheck: ['${(A + const.BLS12381_P - C) % const.BLS12381_P} => E', 
                                                        '${(B + const.BLS12381_P - D) % const.BLS12381_P} :ARITH_BLS12381_SUBFP2',
                                                        '${ARITH_BLS12381_SUBFP2(A,C)} => E',
                                                        '${ARITH_BLS12381_SUBFP2(B,D)} :ARITH_BLS12381_SUBFP2']},

              ARITH_BLS12381_MULFP2: { eq: 9, rcheck: ['${(A*C) >= (B*D) ? (((A*C)-(B*D)) % const.BLS12381_P) : (const.BLS12381_P - (((B*D)-(A*C)) % const.BLS12381_P))} => E', 
                                                        '${((A*D)+(B*C)) % const.BLS12381_P} :ARITH_BLS12381_MULFP2', 
                                                        '${ARITH_BLS12381_MULFP2_X(A,B,C,D)} => E',
                                                        '${ARITH_BLS12381_MULFP2_Y(A,B,C,D)} :ARITH_BLS12381_MULFP2']}
};

//  
// node test/tools/arithTestGen.js | awk '/; redirect:/{F="test/diagnostic/operations/arith/"$3; print "">F;next}{print $0>>F}'
// 

let values = [
    {
        A: 0n,
        B: 0n,
        C: 0n,
        D: 0n,
    },{
        A: 0n,
        B: 0n,
        C: 0n,
        D: 1n,
    },{
        A: 0n,
        B: 0n,
        C: 1n,
        D: 0n,
    },{
        A: 0n,
        B: 0n,
        C: 1n,
        D: 1n,
    },{
        A: 0n,
        B: 1n,
        C: 0n,
        D: 0n,
    },{
        A: 0n,
        B: 1n,
        C: 0n,
        D: 1n,
    },{
        A: 0n,
        B: 1n,
        C: 1n,
        D: 0n,
    },{
        A: 0n,
        B: 1n,
        C: 1n,
        D: 1n,
    },{
        A: 1n,
        B: 0n,
        C: 0n,
        D: 0n,
    },{
        A: 1n,
        B: 0n,
        C: 0n,
        D: 1n,
    },{
        A: 1n,
        B: 0n,
        C: 1n,
        D: 0n,
    },{
        A: 1n,
        B: 0n,
        C: 1n,
        D: 1n,
    },{
        A: 1n,
        B: 1n,
        C: 0n,
        D: 0n,
    },{
        A: 1n,
        B: 1n,
        C: 0n,
        D: 1n,
    },{
        A: 1n,
        B: 1n,
        C: 1n,
        D: 0n,
    },{
        A: 1n,
        B: 1n,
        C: 1n,
        D: 1n,
    },{
        A: 2132730398305190967668080390814n,
        B: 54292886400143341927280054073980425823246656081n,
        C: 1n,
        D: 0n,
    },{
        A: 2999113016370801447448637477310555551699411366746876888402482806647931650955n,
        B: 15111836776712714633472521107426170732646708720491125290424115686452538044788n,
        C: 1615640209694347989024567018706328391116430477872687075840266591062548700110n,
        D: 1n,
    },{
        A: 81468603030918525029495174583781070497912242603115757056778578971061481234340n,
        B: 82059731957542881818342276305803140955137190573407230807241413073234099788414n,
        C: 15732627605783359033920186225560009197248857390142369335038531931634059399896n,
        D: 1n,
    },{
        A: 82404511619898090395080044893130374032931121663279308706641192292251088604573n,
        B: 218016309922137699094797478333585171696794824697587846381595937510543687571n,
        C: 63787468536760849300814264976359137980835693562263609965507003207114627618515n,
        D: 1n,
    },{
        A: 2999113016370801447448637477310555551699411366746876888402482806647931650955n,
        B: 15111836776712714633472521107426170732646708720491125290424115686452538044788n,
        C: 1615640209694347989024567018706328391116430477872687075840266591062548700110n,
        D: 1361179629352358267333550734567663993971386151768430307761609245213368478601n,
    },{
        A: 19056371982582167475593876340225319134850470258276413387066558886464698322210n,
        B: 20914269056602289532121456290808074920610800738424321255588157751277776260456n,
        C: 10634756649036098220049242607700175280465139227303175868315978071819374369450n,
        D: 10707315989258942200484412153631767731310293817155149881083576310392120779817n,
    },{
        A: 17439296149470651955399191622773763934734095199211718365410414983381309759864n,
        B: 13373501719163473472841041788504156690548383160832239692705104418225040546854n,
        C: 2866102972456271079967693190994148543367180063637893133241380333416566770443n,
        D: 17507150703593091179260006606111902033252116738425947814013976030826760340088n,
    },{
        A: 10474021739025925932785928731057203470917859260988012564714012471518727308608n,
        B: 6338187455997332132605156933512585760641763976004436657187920430294343752715n,
        C: 6475980579478677576684459816370306528085724315611555389395716648859900516600n,
        D: 6103770441505827039226012739324368008932137504351034680550554911354633643402n,
    },{
        A: 13035654309185072747007684899608188564738180212873843624120098867068659728379n,
        B: 14304510650501135230770200049037997501161624700690638244767896840233539997021n,
        C: 1254522566763643765518141339826574316876596975171694605176987103074390318626n,
        D: 21865911826269625017932701701554322194779621143559233503634932475964203801698n,
    },{
        A: 2461466524536061550339181353212015521462274663804793738545776528032343767724n,
        B: 14279857303122277929122171225581539676447880100806450816662950153862355043067n,
        C: 10677698019904304413362206508628545451239797883902566541820043776169994991238n,
        D: 6027754328827188358079420890098393565885966458283709242833777097841682926427n,
    },{
        A: 138826511351159327237431406645218469792228779423591846788088579129301438600n,
        B: 10089820941352009655622737406538873385399158068321996168314921591561303625427n,
        C: 20645371170960535603921534856721014539288435278222660642135668426679626515931n,
        D: 1576241632396731897618617265168143028312344467934592563257912942622117021847n,
    },{
        A: 19480032858599349237783739348857222898900985826623279208013807997533177831349n,
        B: 21630444695768116512365032858267470528576164245213349347830255620368276117931n,
        C: 16322101046935066186280288176517090342422396611448788940925337347235910062601n,
        D: 8405301844789429109003953345703925291788605787954685727209642739103427451357n,
    },{
        A: 8279176438218218101317736458812046719029759513136611258705774745931768461256n,
        B: 9362486483192325253707795252004845051132306326244875553694069791619655071971n,
        C: 16636602270147592436099839267995412007762493323489851213306204892790148326206n,
        D: 21456551282858136055393172051335867452225170134977771502424168466799226916474n,
    },{
        A: 21013165940349711590804640157754084232415898489763484115487409886935251766813n,
        B: 20398557100608727082768711435464713620372286029308252256259842527014206510587n,
        C: 5135291992952316672867243702373043725268231953202952303295397600268619298758n,
        D: 7711663949017021656757420710572368884621968601161543401056959791369131705451n,
    },{
        A: 7802749448203350996553316612407949749581043505762467160361662239145921287212n,
        B: 11908441232079727165976055981948582184832610178121943911277897277425131617523n,
        C: 7394421574903366328028623190912377055837054768620632411838375654799652347683n,
        D: 5753007918473130019591276545904511214340216123596976813280744367440338448829n,
    },{
        A: 3213816781616397671686965302147637570172145420338600032641393742383178340709n,
        B: 9159369281061838250513815658806397994903387555927392848527881999279829241092n,
        C: 1570614512386131497091694539141510562071466374104867472304697568390544858673n,
        D: 3028329571581865740331102887241480864607028228100264322539606376688159498061n,
    },{
        A: 0n,
        B: 20461646802298906980762583770860915677116535487874170572552628192653608014730n,
        C: 6992781226881595625739967127142000520977098989512983986793047316871483459918n,
        D: 1378664412189966417004884240232329428343584286374831951394319038115267215211n,
    },{
        A: 8185294398670857206588387453006456912211107202444686619085770886559782939833n,
        B: 0n,
        C: 20430345858968609673351474973766446317558778020642244131730714986194551525821n,
        D: 3003141308976916826947433012885630474801049592871161473113707392201592535716n,
    },{
        A: 19161049757122130269379804349801115723326823420863114519014390733160342246998n,
        B: 13615253125279716961815379356918687191433028139889485610239584740287529516760n,
        C: 0n,
        D: 9186799348640615165090642464739742804207214968625748747967213089636966092042n,
    },{
        A: 20530596605376994910007569173016238557447322979422639258302340622059080394453n,
        B: 13817132582425877466415083224775808689552025130277905327859870628768938090276n,
        C: 17997268041396051959441677056635319964274407682764321547780102319863176442806n,
        D: 0n,
    },{
        A: P_BN254 - 1n,
        B: P_BN254 - 1n,
        C: P_BN254 - 1n,
        D: P_BN254 - 1n,
    },{
        A: two256,
        B: two256,
        C: two256,
        D: two256,
    },{
        A: two256,
        B: two256,
        C: 0n,
        D: 0n,
    },{
        A: two256,
        B: 0n,
        C: two256,
        D: 0n,
    },{
        _mode384: true,
        A: P_BLS12381 - 1n,
        B: P_BLS12381 - 1n,
        C: P_BLS12381 - 1n,
        D: P_BLS12381 - 1n,
    },{
        _mode384: true,
        A: P2_384,
        B: P2_384,
        C: P2_384,
        D: P2_384,
    },{
        _mode384: true,
        A: P2_384,
        B: P2_384,
        C: 0n,
        D: 0n,
    },{
        _mode384: true,
        A: P2_384,
        B: 0n,
        C: P2_384,
        D: 0n,
    }
]

class ArithEqs {
    ARITH(A,B,C) {
        const value = A*B + C;
        // console.log(`; A:${A} B:${B} C:${C} D:${value >> 256n} op:${value & two256}`);
        return [value >> 256n, value & two256];
    }

    ARITH_MOD(A,B,C,D) {
        if (D === 0n) D = 1n;
        const val = (A*B + C) % D;
        return [D, val];
    }

    ARITH_BN254_ADDFP2(A,B,C,D) {
        return [(A + C) % P_BN254, (B + D) % P_BN254];
    }

    ARITH_BN254_SUBFP2(A,B,C,D) {
        return [(A + (P_BN254 - C)) % P_BN254, (B + (P_BN254 - D)) % P_BN254];
    }

    ARITH_BN254_MULFP2(A,B,C,D) {
        return [(A*C-((B*D) %P_BN254)+P_BN254) % P_BN254, (A*D+B*C) % P_BN254];
    }

    ARITH_384_MOD(A,B,C,D) {
        if (D === 0n) D = 1n;
        const val = (A*B + C) % D;
        return [D, val];
    }

    ARITH_BLS12381_ADDFP2(A,B,C,D) {
        return [(A + C) % P_BLS12381, (B + D) % P_BLS12381];
    }

    ARITH_BLS12381_SUBFP2(A,B,C,D) {
        return [(A + (P_BLS12381 - C)) % P_BLS12381, (B + (P_BLS12381 - D)) % P_BLS12381];
    }

    ARITH_BLS12381_MULFP2(A,B,C,D) {
        return [(A*C-((B*D) %P_BLS12381)+P_BLS12381) % P_BLS12381, (A*D+B*C) % P_BLS12381];
    }
}


arithEqs = new ArithEqs();
for (const eq in eqs) {
    const eqInfo = eqs[eq];
    const arithEquation = eqInfo.eq;
    let input = {
        x1: 0n,
        y1: 0n,
        x2: 0n,
        y2: 0n,
        x3: 0n,
        y3: 0n,
        arithEquation
    };
    /* const outputFile = eqInfo.file ?? eq.toLowerCase().slice(6);
    const label = `_${eq.toLowerCase()}_tests`;
    console.log(`; redirect: ${outputFile}.zkasm`);
    if (arithEquation >= 8) {
        console.log('PRAGMA MODE_384_BITS\n');
    }
    console.log(`\t:JMP(${label})\n`);
    console.log(`__REDUNDANT_${eq}_CHECK:\n`);
    for (const line of eqInfo.rcheck) {
        console.log('\t'+line);
    }
    console.log('\t\t\t:RETURN\n');
    console.log(`${label}:\n`);*/
    let done = {};
    for (const value of values) {
        if (value._mode384 && arithEquation < 8) continue;
        if (arithEquation === 2 && value.A == value.C) continue;
        input.x1 = value.A;
        input.y1 = value.B;
        input.x2 = value.C;
        input.arithEquation = BigInt(arithEquation);

        let E = 0n;
        let D = 0n;
        let op = 0n;
        let regs = {A: value.A, B: value.B, C: value.C};
        const params = Object.keys(value).filter(x => !x.startsWith('_')).map(x => value[x]);
        if (eq.endsWith('_MOD')) {
            [D, op] = arithEqs[eq].apply(arithEqs, params);
            input.y2 = D;
            input.x3 = 0n; // E register is not used
            regs.D = D;
        } else if (eq === 'ARITH') {
            [D, op] = arithEqs[eq].apply(arithEqs, params);
            input.y2 = D;
            input.x3 = 0n;
            regs.D = D;
            regs.E = 0n;
        } else {
            input.y2 = value.D;
            [E, op] = arithEqs[eq].apply(arithEqs, params);
            input.x3 = E;
            regs.D = value.D;
            regs.E = E;
        }
        const key = 'K' + Object.entries(regs).map(x => x.join(':')).join('|');
        if (done[key]) continue;
        done[key] = true;
        input.y3 = op;
        console.log(input,","); // This is for the arithmetic tests
        for (const reg in regs) {
            // console.log(`\t${regs[reg]}n => ${reg}`);
        }
        // console.log(`\t${op}n :${eq}\n\t:CALL(__REDUNDANT_${eq}_CHECK)\n`);
    }
}