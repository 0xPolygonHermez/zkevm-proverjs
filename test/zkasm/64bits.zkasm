VAR GLOBAL oldStateRoot[4]
VAR GLOBAL oldAccInputHash[4]
VAR GLOBAL newStateRoot[4]
VAR GLOBAL newAccInputHash[4]
VAR GLOBAL newLocalExitRoot[4]

start:

        STEP => A
        0 :ASSERT

        ; from STEP 2
        ${getPublicOldStateRootR64(0)} :MSTORE(oldStateRoot[0])
        ${getPublicOldStateRootR64(1)} :MSTORE(oldStateRoot[1])
        ${getPublicOldStateRootR64(2)} :MSTORE(oldStateRoot[2])
        ${getPublicOldStateRootR64(3)} :MSTORE(oldStateRoot[3])

        ${getPublicOldAccInputHashR64(0)} :MSTORE(oldAccInputHash[0])
        ${getPublicOldAccInputHashR64(1)} :MSTORE(oldAccInputHash[1])
        ${getPublicOldAccInputHashR64(2)} :MSTORE(oldAccInputHash[2])
        ${getPublicOldAccInputHashR64(3)} :MSTORE(oldAccInputHash[3])


        0xFFFFFFFFFFFFFFFFn => A,B
        0n => C
        0xFFFFFFFFFFFFFFFEn => D
        1 :ARITH


        0xFFFFFFFFFFFFFFFFn => A,B
        0xFFFFFFFFFFFFFFFFn => C
        0xFFFFFFFFFFFFFFFFn => D
        0 :ARITH

        0xFFFFFFFFFFFFFFFFn => A,B
        0xFFFFFFFFFFFFFFFEn :ADD,JMPC(on_carry)

        0                   :ASSERT ; fails A != 0

on_carry:

        0x7FFFFFFFFFFFFFFFn => A
        0x8000000000000000n => B
        0xFFFFFFFFFFFFFFFFn :ADD,JMPC(on_carry_2)

                            :JMP(no_carry)
on_carry_2:

        0                   :ASSERT ; fails A != 0

no_carry:

        0 => HASHPOS
        8 => D

        ; 0x5E1268E5B2A8DC1D0BB047386FC227FA4C852DBA596511B9EAF7FCDD79C9006Dn :HASHK(E) 256-bits machine

        0x5E1268E5B2A8DC1Dn :HASHK(E)
        0x0BB047386FC227FAn :HASHK(E)
        0x4C852DBA596511B9n :HASHK(E)
        0xEAF7FCDD79C9006Dn :HASHK(E)

        0x5E1268E5B2A8DC1Dn :HASHK(E)
        0x0BB047386FC227FAn :HASHK(E)
        0x4C852DBA596511B9n :HASHK(E)
        0xEAF7FCDD79C9006Dn :HASHK(E)

        0x5E1268E5B2A8DC1Dn :HASHK(E)
        0x0BB047386FC227FAn :HASHK(E)
        0x4C852DBA596511B9n :HASHK(E)
        0xEAF7FCDD79C9006Dn :HASHK(E)

        0x5E1268E5B2A8DC1Dn :HASHK(E)
        0x0BB047386FC227FAn :HASHK(E)
        0x4C852DBA596511B9n :HASHK(E)
        0xEAF7FCDD79C9006Dn :HASHK(E)

        7 => D
        0x5E1268E5B2A8DCn   :HASHK(E)

        135                 :HASHKLEN(E)


        ${hashKDigestR64(E, 1)} => A
        ${hashKDigestR64(E, 2)} => B
        ${hashKDigestR64(E, 3)} => C
        ${hashKDigestR64(E, 0)}   :HASHKDIGEST(E)


end:
        0 => A,B,C,D,E,CTX, SP, PC, GAS

finalWait:
        ${beforeLast(12)}  : JMPN(finalWait)

        $ :MLOAD(newStateRoot[0])
        $ :MLOAD(newStateRoot[1])
        $ :MLOAD(newStateRoot[2])
        $ :MLOAD(newStateRoot[3])

        $ :MLOAD(newAccInputHash[0])
        $ :MLOAD(newAccInputHash[1])
        $ :MLOAD(newAccInputHash[2])
        $ :MLOAD(newAccInputHash[3])

        $ :MLOAD(newLocalExitRoot[0])
        $ :MLOAD(newLocalExitRoot[1])
        $ :MLOAD(newLocalExitRoot[2])
        $ :MLOAD(newLocalExitRoot[3]),JMP(start)
opINVALID: