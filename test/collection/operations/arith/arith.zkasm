; constants needed by executor C++
CONST %N = 2**19
CONST %MAX_CNT_STEPS_LIMIT = %N
CONST %MAX_CNT_ARITH_LIMIT = %N
CONST %MAX_CNT_BINARY_LIMIT = %N
CONST %MAX_CNT_MEM_ALIGN_LIMIT = %N
CONST %MAX_CNT_KECCAK_F_LIMIT = %N
CONST %MAX_CNT_PADDING_PG_LIMIT = %N
CONST %MAX_CNT_POSEIDON_G_LIMIT = %N

VAR GLOBAL lastHashKId
VAR GLOBAL lastHashPId

VAR GLOBAL initial_A
VAR GLOBAL initial_B
VAR GLOBAL initial_C
VAR GLOBAL initial_D
VAR GLOBAL initial_E
VAR GLOBAL initial_CTX
VAR GLOBAL initial_SP
VAR GLOBAL initial_PC
VAR GLOBAL initial_GAS
VAR GLOBAL initial_SR
VAR GLOBAL initial_RR
VAR GLOBAL initial_HASHPOS
VAR GLOBAL initial_RCX

start:

        STEP => A
        0 :ASSERT


        A           :MSTORE(initial_A)
        B           :MSTORE(initial_B)
        C           :MSTORE(initial_C)
        D           :MSTORE(initial_D)
        E           :MSTORE(initial_E)
        CTX         :MSTORE(initial_CTX)
        SP          :MSTORE(initial_SP)
        PC          :MSTORE(initial_PC)
        GAS         :MSTORE(initial_GAS)
        SR          :MSTORE(initial_SR)
        RR          :MSTORE(initial_RR)
        HASHPOS     :MSTORE(initial_HASHPOS)
        RCX         :MSTORE(initial_RCX)
        0 => A,B,C,D,E,CTX, SP, PC, GAS, SR, RR, HASHPOS, RCX

        -1          :MSTORE(lastHashKId)
        -1          :MSTORE(lastHashPId)

                    :JMP(init)

REDUNDANT_ARITH_CHECK:

        $${var _arithComp = A*B + C}
        ${_arithComp >> 256} => D
        ${_arithComp} => E :ARITH

        :RETURN

REDUNDANT_ARITH_MOD_CHECK:

        ${(A*B + C) % D} :ARITH_MOD
			 :RETURN


init:
        ${dump(CNT_ARITH)}

edge_cases:
	; 1] Modulo 0 tests: Remember that a = b (mod 0) iff a = b

	; This should not pass the PIL, as the lookups against D ensure that op < D, which is 0 in this case.
	; Hence, it cannot be satisfied.

	; 2] Modulo 1 tests: Remember that a = b (mod 1) iff b = 0

        0n => A
        0n => B
        0n => C
        1n => D
        0n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        1n => A
        0n => B
        0n => C
        1n => D
        0n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        0n => A
        1n => B
        0n => C
        1n => D
        0n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        0n => A
        0n => B
        1n => C
        1n => D
        0n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        2999113016370801447448637477310555551699411366746876888402482806647931650955n => A
        15111836776712714633472521107426170732646708720491125290424115686452538044788n => B
        1615640209694347989024567018706328391116430477872687075840266591062548700110n => C
        1n => D
        0n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        81468603030918525029495174583781070497912242603115757056778578971061481234340n => A
        82059731957542881818342276305803140955137190573407230807241413073234099788414n => B
        15732627605783359033920186225560009197248857390142369335038531931634059399896n => C
        1n => D
        0n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        82404511619898090395080044893130374032931121663279308706641192292251088604573n => A
        218016309922137699094797478333585171696794824697587846381595937510543687571n => B
        63787468536760849300814264976359137980835693562263609965507003207114627618515n => C
        1n => D
        0n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)


arith_tests:
        0n => A
        0n => B
        0n => C
        0n => D
        0n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        2132730398305190967668080390814n => A
        54292886400143341927280054073980425823246656081n => B
        1n => C
        0n => D
        115792089237316195423570985008687907853269984665640564039457584007913129639935n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        2999113016370801447448637477310555551699411366746876888402482806647931650955n => A
        15111836776712714633472521107426170732646708720491125290424115686452538044788n => B
        1615640209694347989024567018706328391116430477872687075840266591062548700110n => C
        391409349955006868524657492023052151566507850362591821568835178165026516392n => D
        56741326946232940441581194939148117954896938098663780980310669483579759841738n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        81468603030918525029495174583781070497912242603115757056778578971061481234340n => A
        82059731957542881818342276305803140955137190573407230807241413073234099788414n => B
        15732627605783359033920186225560009197248857390142369335038531931634059399896n => C
        57735306200159464795048706492851038802576920004259228852669819897092571831938n => D
        46298907100611992925367301573737661891511452547003478700344338972297765260688n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        82404511619898090395080044893130374032931121663279308706641192292251088604573n => A
        218016309922137699094797478333585171696794824697587846381595937510543687571n => B
        63787468536760849300814264976359137980835693562263609965507003207114627618515n => C
        155153324053819452143351320373462368629665219112921824673950263628546255024n => D
        24292137737474229803263257426111796666251284708707033788904008056684350442234n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        2999113016370801447448637477310555551699411366746876888402482806647931650955n => A
        15111836776712714633472521107426170732646708720491125290424115686452538044788n => B
        1615640209694347989024567018706328391116430477872687075840266591062548700110n => C
        391409349955006868524657492023052151566507850362591821568835178165026516392n => D
        56741326946232940441581194939148117954896938098663780980310669483579759841738n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        19056371982582167475593876340225319134850470258276413387066558886464698322210n => A
        20914269056602289532121456290808074920610800738424321255588157751277776260456n => B
        10634756649036098220049242607700175280465139227303175868315978071819374369450n => C
        3441945762543342458883150241050519308530807216124646305755116986410643898322n => D
        28920520258419236307213812277414772840256786008396495164112297814807289309818n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        17439296149470651955399191622773763934734095199211718365410414983381309759864n => A
        13373501719163473472841041788504156690548383160832239692705104418225040546854n => B
        2866102972456271079967693190994148543367180063637893133241380333416566770443n => C
        2014165722132818253602016838071932372682960808610076839653584931822265702539n => D
        14142176564730654047027199451285539569303710865220728561145846767819396440795n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        10474021739025925932785928731057203470917859260988012564714012471518727308608n => A
        6338187455997332132605156933512585760641763976004436657187920430294343752715n => B
        6475980579478677576684459816370306528085724315611555389395716648859900516600n => C
        573323390547678609656668694225316508804564637502434204897372474652376837429n => D
        76739414710814357023578173816377835808459476686119292656336483174161365422776n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        13035654309185072747007684899608188564738180212873843624120098867068659728379n => A
        14304510650501135230770200049037997501161624700690638244767896840233539997021n => B
        1254522566763643765518141339826574316876596975171694605176987103074390318626n => C
        1610374742611482589611979199836228002721247140776758415232282433306600436357n => D
        14625398671283886906322841257813830796761713928333933432211144589280825924433n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        2461466524536061550339181353212015521462274663804793738545776528032343767724n => A
        14279857303122277929122171225581539676447880100806450816662950153862355043067n => B
        10677698019904304413362206508628545451239797883902566541820043776169994991238n => C
        303556062925408663233255816731152214837230518936289964369600446709612362880n => D
        73038097870624733091161563438231474920319916631358586997830295106000487585066n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        138826511351159327237431406645218469792228779423591846788088579129301438600n => A
        10089820941352009655622737406538873385399158068321996168314921591561303625427n => B
        20645371170960535603921534856721014539288435278222660642135668426679626515931n => C
        12096980464485449235610434056983540715682558935898255909123199181114263356n => D
        77502658970127775318645055309663187455119822092300904628519520677248106812915n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        19480032858599349237783739348857222898900985826623279208013807997533177831349n => A
        21630444695768116512365032858267470528576164245213349347830255620368276117931n => B
        16322101046935066186280288176517090342422396611448788940925337347235910062601n => C
        3638951297925861207975479155016555682787455675672366689997549072253996614310n => D
        43822737688058616615302823702187591175709258634657325656578208298461697797360n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        8279176438218218101317736458812046719029759513136611258705774745931768461256n => A
        9362486483192325253707795252004845051132306326244875553694069791619655071971n => B
        16636602270147592436099839267995412007762493323489851213306204892790148326206n => C
        669421184170172089422259999137573774079456377447721856264649902624128461555n => D
        57272602708731250326037150787323978865072074434975463974963713173157984721302n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        21013165940349711590804640157754084232415898489763484115487409886935251766813n => A
        20398557100608727082768711435464713620372286029308252256259842527014206510587n => B
        5135291992952316672867243702373043725268231953202952303295397600268619298758n => C
        3701792308283641054321523848473945052269941387633342511085210485988923931178n => D
        25561542134899953733657055540559553821296749555247238450695028853347174723381n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        7802749448203350996553316612407949749581043505762467160361662239145921287212n => A
        11908441232079727165976055981948582184832610178121943911277897277425131617523n => B
        7394421574903366328028623190912377055837054768620632411838375654799652347683n => C
        802460546869788664643522258338312761698425255920819927036115633589263361274n => D
        60250112472560001710182699641660904004203100349612020438013558925670761125095n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        3213816781616397671686965302147637570172145420338600032641393742383178340709n => A
        9159369281061838250513815658806397994903387555927392848527881999279829241092n => B
        1570614512386131497091694539141510562071466374104867472304697568390544858673n => C
        254218875385934170819975617093813489851025683992341881454635237591587706933n => D
        62785527803350341043721897254923868630301500878839177049949130221587643196613n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        0n => A
        20461646802298906980762583770860915677116535487874170572552628192653608014730n => B
        6992781226881595625739967127142000520977098989512983986793047316871483459918n => C
        0n => D
        6992781226881595625739967127142000520977098989512983986793047316871483459918n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        8185294398670857206588387453006456912211107202444686619085770886559782939833n => A
        0n => B
        20430345858968609673351474973766446317558778020642244131730714986194551525821n => C
        0n => D
        20430345858968609673351474973766446317558778020642244131730714986194551525821n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        19161049757122130269379804349801115723326823420863114519014390733160342246998n => A
        13615253125279716961815379356918687191433028139889485610239584740287529516760n => B
        0n => C
        2253025610882776107558770216719970508208356630211452995359873596256304800266n => D
        26320061407833988427735911051700574873718264576876833744402938696786523663504n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

        21888242871839275222246405745257275088696311157297823662689037894645226208582n => A
        21888242871839275222246405745257275088696311157297823662689037894645226208582n => B
        21888242871839275222246405745257275088696311157297823662689037894645226208582n => C
        4137546694012196313615514819619774299549115026185221663042307357682442875788n => D
        95897944360357395708843619722285667676599391685337542238008961638562984389738n :ARITH
        :CALL(REDUNDANT_ARITH_CHECK)

arith_mod_tests:
        2999113016370801447448637477310555551699411366746876888402482806647931650955n => A
        15111836776712714633472521107426170732646708720491125290424115686452538044788n => B
        1615640209694347989024567018706328391116430477872687075840266591062548700110n => C
        1361179629352358267333550734567663993971386151768430307761609245213368478601n => D
        404015105271178249425009211149116162497505566541229562622044717743632013489n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        19056371982582167475593876340225319134850470258276413387066558886464698322210n => A
        20914269056602289532121456290808074920610800738424321255588157751277776260456n => B
        10634756649036098220049242607700175280465139227303175868315978071819374369450n => C
        10707315989258942200484412153631767731310293817155149881083576310392120779817n => D
        6920609207119167395959131992066380589796703421563779918050515844861464646812n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        17439296149470651955399191622773763934734095199211718365410414983381309759864n => A
        13373501719163473472841041788504156690548383160832239692705104418225040546854n => B
        2866102972456271079967693190994148543367180063637893133241380333416566770443n => C
        17507150703593091179260006606111902033252116738425947814013976030826760340088n => D
        10052075360659133610178775562935207105650501315577207626023127405555835445395n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        10474021739025925932785928731057203470917859260988012564714012471518727308608n => A
        6338187455997332132605156933512585760641763976004436657187920430294343752715n => B
        6475980579478677576684459816370306528085724315611555389395716648859900516600n => C
        6103770441505827039226012739324368008932137504351034680550554911354633643402n => D
        2131399326112928253163000516339603764514234563528824209426723579293516793830n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        13035654309185072747007684899608188564738180212873843624120098867068659728379n => A
        14304510650501135230770200049037997501161624700690638244767896840233539997021n => B
        1254522566763643765518141339826574316876596975171694605176987103074390318626n => C
        21865911826269625017932701701554322194779621143559233503634932475964203801698n => D
        19060840572116276799395515686951107280832123139436836058873991723346108954587n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        2461466524536061550339181353212015521462274663804793738545776528032343767724n => A
        14279857303122277929122171225581539676447880100806450816662950153862355043067n => B
        10677698019904304413362206508628545451239797883902566541820043776169994991238n => C
        6027754328827188358079420890098393565885966458283709242833777097841682926427n => D
        1700400505851492266144427504663814837088423079316714884550669907503389410938n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        138826511351159327237431406645218469792228779423591846788088579129301438600n => A
        10089820941352009655622737406538873385399158068321996168314921591561303625427n => B
        20645371170960535603921534856721014539288435278222660642135668426679626515931n => C
        1576241632396731897618617265168143028312344467934592563257912942622117021847n => D
        417228420091254198641630913313580327626260071880590542554600219548713219432n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        19480032858599349237783739348857222898900985826623279208013807997533177831349n => A
        21630444695768116512365032858267470528576164245213349347830255620368276117931n => B
        16322101046935066186280288176517090342422396611448788940925337347235910062601n => C
        8405301844789429109003953345703925291788605787954685727209642739103427451357n => D
        4328492536794014288879534544208399496522776312339269353413330744298330382802n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        8279176438218218101317736458812046719029759513136611258705774745931768461256n => A
        9362486483192325253707795252004845051132306326244875553694069791619655071971n => B
        16636602270147592436099839267995412007762493323489851213306204892790148326206n => C
        21456551282858136055393172051335867452225170134977771502424168466799226916474n => D
        11946175367799795792643809742623851445014167992152045956511818757531233461764n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        21013165940349711590804640157754084232415898489763484115487409886935251766813n => A
        20398557100608727082768711435464713620372286029308252256259842527014206510587n => B
        5135291992952316672867243702373043725268231953202952303295397600268619298758n => C
        7711663949017021656757420710572368884621968601161543401056959791369131705451n => D
        5464814742023386643892144352978566442860206939211009064242276602592636645809n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        7802749448203350996553316612407949749581043505762467160361662239145921287212n => A
        11908441232079727165976055981948582184832610178121943911277897277425131617523n => B
        7394421574903366328028623190912377055837054768620632411838375654799652347683n => C
        5753007918473130019591276545904511214340216123596976813280744367440338448829n => D
        2686443253640485239529359828611970632857875480487272973175263608183768614006n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        3213816781616397671686965302147637570172145420338600032641393742383178340709n => A
        9159369281061838250513815658806397994903387555927392848527881999279829241092n => B
        1570614512386131497091694539141510562071466374104867472304697568390544858673n => C
        3028329571581865740331102887241480864607028228100264322539606376688159498061n => D
        1266881352592634754493129698881478469229549466999947015278093117056475677485n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        0n => A
        20461646802298906980762583770860915677116535487874170572552628192653608014730n => B
        6992781226881595625739967127142000520977098989512983986793047316871483459918n => C
        1378664412189966417004884240232329428343584286374831951394319038115267215211n => D
        99459165931763540715545925980353379259177557638824229821452126295147383863n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        8185294398670857206588387453006456912211107202444686619085770886559782939833n => A
        0n => B
        20430345858968609673351474973766446317558778020642244131730714986194551525821n => C
        3003141308976916826947433012885630474801049592871161473113707392201592535716n => D
        2411498005107108711666876896452663468752480463415275293048470632984996311525n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        19161049757122130269379804349801115723326823420863114519014390733160342246998n => A
        13615253125279716961815379356918687191433028139889485610239584740287529516760n => B
        0n => C
        9186799348640615165090642464739742804207214968625748747967213089636966092042n => D
        390198219313817495325097024061877808187575580054772508084692514680002143160n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        21888242871839275222246405745257275088696311157297823662689037894645226208582n => A
        21888242871839275222246405745257275088696311157297823662689037894645226208582n => B
        21888242871839275222246405745257275088696311157297823662689037894645226208582n => C
        21888242871839275222246405745257275088696311157297823662689037894645226208582n => D
        0n :ARITH_MOD
        :CALL(REDUNDANT_ARITH_MOD_CHECK)

        ${dump(CNT_ARITH)}

end:

        $ => A           :MLOAD(initial_A)
        $ => B           :MLOAD(initial_B)
        $ => C           :MLOAD(initial_C)
        $ => D           :MLOAD(initial_D)
        $ => E           :MLOAD(initial_E)
        $ => CTX         :MLOAD(initial_CTX)
        $ => SP          :MLOAD(initial_SP)
        $ => PC          :MLOAD(initial_PC)
        $ => GAS         :MLOAD(initial_GAS)
        $ => SR          :MLOAD(initial_SR)
        $ => RR          :MLOAD(initial_RR)
        $ => HASHPOS     :MLOAD(initial_HASHPOS)
        $ => RCX         :MLOAD(initial_RCX)

; label finalizeExecution needed by executor C++
finalizeExecution:
        ${beforeLast()}  : JMPN(finalizeExecution)

                         : JMP(start)
opINVALID:
; label checkAndSaveFrom needed by executor C++
checkAndSaveFrom:
                         :JMP(opINVALID)
